<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dks5: Мой Видео-Архив</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .neo-glow-box {
            background-color: #2a2a4e;
            border-radius: 1.5rem;
            border: 1px solid #4a4a8a;
            box-shadow: 0 0 25px rgba(173, 114, 239, 0.3),
                        0 0 10px rgba(173, 114, 239, 0.2) inset;
            transition: all 0.3s ease;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .btn-danger {
            background-color: #991b1b;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #4a4a8a;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="text-center w-full max-w-6xl mx-auto mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-violet-300 mb-2">dks5: Мой Видео-Архив</h1>
        <p class="text-lg md:text-xl text-gray-400 mb-6">Управление категориями и ссылками на видео</p>
        
        <div class="flex justify-center items-center flex-wrap gap-4 mb-6">
            <button id="signin-button" class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-5 rounded-lg transition-all flex items-center space-x-2">
                <ion-icon name="logo-github"></ion-icon>
                <span>Войти (Админ)</span>
            </button>
            <button id="google-signin-button" class="bg-blue-700 hover:bg-blue-600 text-white py-2 px-5 rounded-lg transition-all flex items-center space-x-2">
                <ion-icon name="logo-google"></ion-icon>
                <span>Войти (Google)</span>
            </button>
            
            <div id="view-controls" class="hidden bg-gray-800 rounded-lg p-1 border border-gray-700 flex items-center space-x-1">
                <button id="view-grid-btn" class="p-2 rounded hover:bg-gray-700 text-violet-300 transition-all" title="Вид: Сетка">
                    <ion-icon name="grid-outline"></ion-icon>
                </button>
                <button id="view-list-btn" class="p-2 rounded hover:bg-gray-700 text-gray-400 transition-all" title="Вид: Список">
                    <ion-icon name="list-outline"></ion-icon>
                </button>
                <div class="w-px h-6 bg-gray-600 mx-1"></div>
                <button id="reset-sort-btn" class="p-2 rounded hover:bg-gray-700 text-yellow-400 transition-all" title="Сбросить сортировку (Умная: 1, 2, 10)">
                    <ion-icon name="filter-outline"></ion-icon>
                </button>
            </div>

            <button id="signout-button" class="hidden bg-gray-700 hover:bg-gray-600 text-white py-2 px-5 rounded-lg transition-all flex items-center space-x-2">
                <ion-icon name="log-out-outline"></ion-icon>
                <span>Выйти</span>
            </button>
        </div>
        <p id="user-display" class="hidden text-green-400 mb-6"></p>

        <div class="flex justify-center items-center space-x-2 sm:space-x-4 flex-wrap gap-2">
            <div id="import-button-wrapper" class="relative inline-block" style="display: none;">
                <button onclick="document.getElementById('import-file-input').click()" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center space-x-2">
                    <ion-icon name="cloud-upload-outline"></ion-icon>
                    <span>Импорт JSON</span>
                </button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>

            <button id="export-button" class="bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center space-x-2" style="display: none;">
                <ion-icon name="cloud-download-outline"></ion-icon>
                <span>Экспорт JSON</span>
            </button>
            
            <button id="reset-button" class="btn-danger hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center space-x-2" style="display: none;">
                <ion-icon name="trash-bin-outline"></ion-icon>
                <span>Сброс данных</span>
            </button>
        </div>
    </header>

    <main id="main-content" class="w-full max-w-6xl mx-auto" style="display: none;">
        <div id="loading-indicator" class="text-center text-lg text-gray-400 p-10">
            <p>Загрузка данных из Firebase...</p>
            <p id="error-message" class="text-red-400 font-bold mt-4"></p>
        </div>

        <div id="add-category-box" class="neo-glow-box p-6 mb-8" style="display: none;">
            <form id="add-category-form" class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="category-name-input" placeholder="Название новой категории" class="flex-grow bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500" required>
                <button type="submit" class="bg-violet-600 hover:bg-violet-500 text-white font-semibold py-3 px-6 rounded-lg transition-all flex justify-center items-center space-x-2">
                    <ion-icon name="add-circle-outline"></ion-icon>
                    <span>Создать категорию</span>
                </button>
            </form>
        </div>

        <div id="categories-container" class="space-y-8"></div>
    </main>

    <div id="video-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="neo-glow-box w-full max-w-lg p-6 relative">
            <h3 id="video-modal-title" class="text-2xl font-bold text-violet-300 mb-6">Добавить видео</h3>
            <form id="video-form">
                <input type="hidden" id="video-id-input">
                <input type="hidden" id="category-id-input">
                <div class="mb-4">
                    <label for="video-name-input" class="block text-sm font-medium text-gray-300 mb-2">Название видео</label>
                    <input type="text" id="video-name-input" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500" required>
                </div>
                <div class="mb-4">
                    <label for="video-url-input" class="block text-sm font-medium text-gray-300 mb-2">URL (ссылка)</label>
                    <input type="url" id="video-url-input" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500" required>
                </div>
                <div class="mb-6">
                    <label for="video-desc-input" class="block text-sm font-medium text-gray-300 mb-2">Описание (по желанию)</label>
                    <textarea id="video-desc-input" rows="3" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-video-modal" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg transition-all">Отмена</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-5 rounded-lg transition-all">Сохранить</button>
                </div>
            </form>
            <button id="close-video-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-all">
                <ion-icon name="close-outline" class="text-3xl"></ion-icon>
            </button>
        </div>
    </div>
    
    <div id="custom-confirm-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="neo-glow-box w-full max-w-md p-6 relative">
            <h3 id="custom-confirm-title" class="text-2xl font-bold text-yellow-300 mb-4">Требуется подтверждение</h3>
            <p id="custom-confirm-text" class="text-gray-300 mb-6">Вы уверены?</p>
            <div class="flex justify-end space-x-4">
                <button id="custom-confirm-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg transition-all">Отмена</button>
                <button id="custom-confirm-ok" class="bg-red-600 hover:bg-red-500 text-white font-semibold py-2 px-5 rounded-lg transition-all">Подтвердить</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            GithubAuthProvider,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // НАСТРОЙКИ ДОСТУПА
        // ==========================================
        const MANUAL_FIREBASE_CONFIG = {
            "apiKey": "AIzaSyAI2eGIMAHw3LWpRTATXBd2di6d2nJoj2w",
            "authDomain": "archive-89fc1.firebaseapp.com",
            "projectId": "archive-89fc1",
            "storageBucket": "archive-89fc1.firebasestorage.app",
            "messagingSenderId": "1023136270041",
            "appId": "1:1023136270041:web:02af4902a9d9f53c4920c8"
        };
        const MANUAL_APP_ID = "youtube-archive-data";
        
        const ADMIN_UID = "56vTQLliI7gcBuvOgKdFzBDl90y1"; 
        
        // СПИСОК ЗРИТЕЛЕЙ
        const ALLOWED_VIEWERS = [
            "pGNffia925Pb4lXcjTODFGtrNlL2", 
            "fGeqhS4Y7sSMrVJfGktGBHR0fUM2"
        ];
        // ==========================================
        
        let db, auth, userId, appId;
        let categoriesCollectionRef; 
        let unsubscribeCategories = null; 
        let currentViewMode = localStorage.getItem('dks5_view_mode') || 'grid'; 

        // UI Elements
        const mainContent = document.getElementById('main-content');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const categoriesContainer = document.getElementById('categories-container');
        
        const importButtonWrapper = document.getElementById('import-button-wrapper');
        const importFileInput = document.getElementById('import-file-input');
        const exportButton = document.getElementById('export-button');
        const resetButton = document.getElementById('reset-button');
        
        const signinButton = document.getElementById('signin-button');
        const googleSigninButton = document.getElementById('google-signin-button');
        const signoutButton = document.getElementById('signout-button');
        const userDisplay = document.getElementById('user-display');
        
        const addCategoryBox = document.getElementById('add-category-box');
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryNameInput = document.getElementById('category-name-input');

        const viewControls = document.getElementById('view-controls');
        const viewGridBtn = document.getElementById('view-grid-btn');
        const viewListBtn = document.getElementById('view-list-btn');
        const resetSortBtn = document.getElementById('reset-sort-btn');

        const videoModal = document.getElementById('video-modal');
        const videoModalTitle = document.getElementById('video-modal-title');
        const videoForm = document.getElementById('video-form');
        const videoIdInput = document.getElementById('video-id-input');
        const categoryIdInput = document.getElementById('category-id-input');
        const videoNameInput = document.getElementById('video-name-input');
        const videoUrlInput = document.getElementById('video-url-input');
        const videoDescInput = document.getElementById('video-desc-input');
        const cancelVideoModal = document.getElementById('cancel-video-modal');
        const closeVideoModal = document.getElementById('close-video-modal');
        
        const confirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('custom-confirm-title');
        const confirmText = document.getElementById('custom-confirm-text');
        const confirmCancel = document.getElementById('custom-confirm-cancel');
        const confirmOk = document.getElementById('custom-confirm-ok');
        let confirmResolve = null; 

        
        // --- Инициализация ---
        async function initFirebase() {
            try {
                let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MANUAL_FIREBASE_CONFIG;
                appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_APP_ID;
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                categoriesCollectionRef = collection(db, `artifacts/${appId}/public/data/categories`);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; 
                        const isAdmin = user.uid === ADMIN_UID;
                        const isViewer = ALLOWED_VIEWERS.includes(user.uid);
                        
                        console.log(`User: ${user.uid}, Admin: ${isAdmin}, Viewer: ${isViewer}`);
                        
                        if (!isAdmin && !isViewer) {
                            console.warn("--- UID НЕАВТОРИЗОВАННОГО ПОЛЬЗОВАТЕЛЯ: ---");
                            console.warn(user.uid);
                        }

                        setupInterface(user, isAdmin, isViewer);
                        
                        if (isAdmin || isViewer) {
                            setupCategoriesListener(isAdmin);
                        }
                    } else {
                        setupInterface(null, false, false);
                        loadingIndicator.classList.add('hidden');
                        categoriesContainer.innerHTML = '';
                    }
                });

                setupViewControls(); 

            } catch (error) {
                console.error("Firebase init error:", error);
                loadingIndicator.textContent = "Ошибка инициализации.";
                errorMessage.textContent = error.message;
            }
        }
        
        // --- Логика Вида и Сортировки ---
        function setupViewControls() {
            updateViewButtons();

            viewGridBtn.addEventListener('click', () => {
                currentViewMode = 'grid';
                localStorage.setItem('dks5_view_mode', 'grid');
                updateViewButtons();
                refreshDisplay();
            });

            viewListBtn.addEventListener('click', () => {
                currentViewMode = 'list';
                localStorage.setItem('dks5_view_mode', 'list');
                updateViewButtons();
                refreshDisplay();
            });

            // КНОПКА СБРОСА СОРТИРОВКИ (УМНАЯ)
            resetSortBtn.addEventListener('click', async () => {
                if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
                    alert("Только администратор может менять порядок сортировки.");
                    return;
                }

                const confirmed = await showCustomConfirm(
                    "Умная сортировка?",
                    "Это выстроит видео по логическому порядку (1, 2, 10), игнорируя старую ручную сортировку. Продолжить?"
                );

                if (confirmed) {
                    try {
                        loadingIndicator.classList.remove('hidden');
                        loadingIndicator.textContent = "Сортировка...";
                        
                        const snapshot = await getDocs(categoriesCollectionRef);
                        const batch = writeBatch(db);
                        let count = 0;

                        snapshot.forEach(docSnap => {
                            const data = docSnap.data();
                            if (data.videos && Array.isArray(data.videos)) {
                                const sortedVideos = [...data.videos].sort((a, b) => 
                                    (a.name || '').localeCompare(b.name || '', undefined, { numeric: true })
                                );
                                const docRef = doc(categoriesCollectionRef, docSnap.id);
                                batch.update(docRef, { videos: sortedVideos });
                                count++;
                            }
                        });

                        await batch.commit();
                        loadingIndicator.classList.add('hidden');
                        alert(`Сортировка выполнена для ${count} категорий.`);
                    } catch (error) {
                        console.error("Sort reset error:", error);
                        alert("Ошибка: " + error.message);
                        loadingIndicator.classList.add('hidden');
                    }
                }
            });
        }

        function refreshDisplay() {
             if (auth.currentUser && (auth.currentUser.uid === ADMIN_UID || ALLOWED_VIEWERS.includes(auth.currentUser.uid))) {
                const isAdmin = auth.currentUser.uid === ADMIN_UID;
                setupCategoriesListener(isAdmin);
             }
        }

        function updateViewButtons() {
            if (currentViewMode === 'grid') {
                viewGridBtn.classList.add('text-violet-300'); viewGridBtn.classList.remove('text-gray-400');
                viewListBtn.classList.add('text-gray-400'); viewListBtn.classList.remove('text-violet-300');
            } else {
                viewGridBtn.classList.add('text-gray-400'); viewGridBtn.classList.remove('text-violet-300');
                viewListBtn.classList.add('text-violet-300'); viewListBtn.classList.remove('text-gray-400');
            }
        }

        function setupInterface(user, isAdmin, isViewer) {
            const adminDisplay = isAdmin ? 'flex' : 'none';
            const adminBlock = isAdmin ? 'block' : 'none';
            const adminInline = isAdmin ? 'inline-block' : 'none';

            addCategoryBox.style.display = adminBlock;
            exportButton.style.display = adminDisplay;
            importButtonWrapper.style.display = adminInline;
            resetButton.style.display = adminDisplay;
            resetSortBtn.style.display = isAdmin ? 'block' : 'none';

            if (!user) {
                mainContent.style.display = 'none';
                signinButton.style.display = 'flex';
                googleSigninButton.style.display = 'flex';
                signoutButton.style.display = 'none';
                viewControls.classList.add('hidden');
                userDisplay.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.textContent = "Пожалуйста, войдите.";
                errorMessage.textContent = '';
            } else {
                signinButton.style.display = 'none';
                googleSigninButton.style.display = 'none';
                signoutButton.style.display = 'flex';
                userDisplay.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');

                if (isAdmin || isViewer) {
                    mainContent.style.display = 'block';
                    viewControls.classList.remove('hidden');
                    userDisplay.textContent = isAdmin 
                        ? `Вы вошли как: ${user.displayName || 'Администратор'} (Админ)`
                        : `Вы вошли как: ${user.displayName || 'Гость'} (Просмотр)`;
                    userDisplay.className = 'mb-6 text-green-400';
                } else {
                    mainContent.style.display = 'none';
                    viewControls.classList.add('hidden');
                    userDisplay.textContent = `Доступ запрещен. Ваш UID: ${user.uid}`;
                    userDisplay.className = 'mb-6 text-red-400 font-bold';
                    loadingIndicator.classList.remove('hidden');
                    loadingIndicator.textContent = "Нет прав доступа. Сообщите свой UID администратору.";
                    errorMessage.innerHTML = `Скопируйте этот код и отправьте админу:<br>${user.uid}`;
                }
            }
        }

        // --- Categories & Render ---

        function setupCategoriesListener(isAdmin) {
            if (unsubscribeCategories) unsubscribeCategories();
            if (!categoriesCollectionRef) return;

            loadingIndicator.classList.remove('hidden');
            const q = query(categoriesCollectionRef);
            
            unsubscribeCategories = onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                const categories = [];
                snapshot.forEach(doc => categories.push({ id: doc.id, ...doc.data() }));
                
                categories.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
                
                renderCategories(categories, isAdmin);
            }, (error) => {
                console.error("onSnapshot Error:", error);
                if (error.code === 'permission-denied') {
                     loadingIndicator.textContent = "Ошибка доступа к БД.";
                     errorMessage.textContent = "Проверьте Правила (Rules) в Firebase Console.";
                }
            });
        }

        function renderCategories(categories, isAdmin) {
            categoriesContainer.innerHTML = ''; 
            if (categories.length === 0) {
                categoriesContainer.innerHTML = `<p class="text-center text-gray-400">Категорий нет.</p>`;
                return;
            }

            categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'neo-glow-box p-6';
                categoryElement.dataset.categoryId = category.id;

                const videos = category.videos || []; 
                
                let containerClasses = currentViewMode === 'grid' 
                    ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6'
                    : 'flex flex-col gap-3 mb-6';

                const videoListContainer = document.createElement('div');
                videoListContainer.className = `video-list ${containerClasses}`;

                videos.forEach(video => {
                    const videoWrapper = document.createElement('div');
                    videoWrapper.innerHTML = generateVideoCardHTML(video, isAdmin, currentViewMode);
                    videoListContainer.appendChild(videoWrapper.firstElementChild);
                });

                categoryElement.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                        <h3 class="text-3xl font-bold text-violet-300 break-words">${escapeHTML(category.name)}</h3>
                        <div class="flex space-x-2 flex-shrink-0" style="display: ${isAdmin ? 'flex' : 'none'}">
                            <button class="edit-category-btn text-yellow-400 hover:text-yellow-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-all"><ion-icon name="pencil-outline" class="text-xl"></ion-icon></button>
                            <button class="delete-category-btn text-red-500 hover:text-red-400 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-all"><ion-icon name="trash-outline" class="text-xl"></ion-icon></button>
                        </div>
                    </div>
                `;
                categoryElement.appendChild(videoListContainer);
                
                const addBtnDiv = document.createElement('div');
                addBtnDiv.innerHTML = `
                    ${videos.length === 0 ? `<p class="text-gray-500 text-center py-4">Нет видео.</p>` : ''}
                    <button class="add-video-btn bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-5 rounded-lg transition-all flex items-center space-x-2" style="display: ${isAdmin ? 'flex' : 'none'}">
                        <ion-icon name="add-outline"></ion-icon><span>Добавить видео</span>
                    </button>`;
                categoryElement.appendChild(addBtnDiv);
                categoriesContainer.appendChild(categoryElement);

                // Sortable Logic
                if (isAdmin) {
                    new Sortable(videoListContainer, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'sortable-ghost',
                        onEnd: async function (evt) {
                            if (evt.newIndex === evt.oldIndex) return;
                            const newOrderIds = Array.from(videoListContainer.children).map(el => el.dataset.videoId);
                            const reorderedVideos = newOrderIds.map(id => videos.find(v => v.id === id)).filter(v => v);
                            try {
                                await updateDoc(doc(categoriesCollectionRef, category.id), { videos: reorderedVideos });
                            } catch (err) { console.error(err); alert("Ошибка сортировки"); }
                        }
                    });
                }
            });
        }

        function generateVideoCardHTML(video, isAdmin, viewMode) {
            const handle = isAdmin ? `<div class="drag-handle p-2 text-gray-500 hover:text-gray-300 cursor-grab flex items-center justify-center"><ion-icon name="reorder-two-outline" class="text-2xl"></ion-icon></div>` : '';
            const actions = `<div class="flex-shrink-0 flex space-x-2 ${viewMode === 'list' ? 'ml-4' : 'pt-4 mt-4 border-t border-gray-700 justify-end'}" style="display: ${isAdmin ? 'flex' : 'none'}">
                    <button class="edit-video-btn text-gray-400 hover:text-yellow-400 transition-all" data-video-id="${video.id}"><ion-icon name="create-outline" class="text-xl"></ion-icon></button>
                    <button class="delete-video-btn text-gray-400 hover:text-red-500 transition-all" data-video-id="${video.id}"><ion-icon name="trash-bin-outline" class="text-xl"></ion-icon></button>
                </div>`;

            const nameHtml = `<a href="${escapeHTML(video.url || '#')}" target="_blank" class="text-lg font-semibold text-blue-300 hover:text-blue-200 break-words transition-all block leading-tight">${escapeHTML(video.name || 'Без названия')}<ion-icon name="open-outline" class="inline-block text-sm ml-1 opacity-70"></ion-icon></a>`;

            if (viewMode === 'grid') {
                // GRID VIEW
                return `<div class="video-card bg-gray-800 rounded-lg shadow-lg flex flex-col p-4 h-full border border-gray-700 relative group" data-video-id="${video.id}">
                    <div class="flex items-start w-full">${handle}<div class="flex-grow min-w-0 ml-2">${nameHtml}</div></div>
                    <div class="flex-grow pl-10 mt-2"><p class="text-gray-400 text-sm break-words">${escapeHTML(video.description || '')}</p></div>
                    ${actions}
                </div>`;
            } else {
                // LIST VIEW (Исправлено: Название 40%, Описание 60%)
                return `<div class="video-card bg-gray-800 rounded-lg shadow-lg flex flex-row items-center p-3 w-full border border-gray-700" data-video-id="${video.id}">
                    ${handle}
                    <div class="flex-grow min-w-0 ml-3 flex flex-col sm:flex-row sm:items-center gap-2">
                        <div class="sm:w-2/5">${nameHtml}</div>
                        <p class="text-gray-400 text-sm break-words sm:w-3/5 line-clamp-2 sm:line-clamp-1">${escapeHTML(video.description || '')}</p>
                    </div>
                    ${actions}
                </div>`;
            }
        }

        // --- Event Listeners (Standard) ---
        addCategoryForm.addEventListener('submit', async (e) => { e.preventDefault(); if(categoryNameInput.value.trim()) await addDoc(categoriesCollectionRef, {name: categoryNameInput.value.trim(), videos: []}); categoryNameInput.value=''; });
        
        categoriesContainer.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-category-btn')) {
                const id = e.target.closest('[data-category-id]').dataset.categoryId;
                const cat = await getCategory(id);
                const newName = prompt("Название:", cat.name);
                if (newName && newName.trim() !== cat.name) updateDoc(doc(categoriesCollectionRef, id), {name: newName.trim()});
            }
            if (e.target.closest('.delete-category-btn')) {
                const id = e.target.closest('[data-category-id]').dataset.categoryId;
                if (await showCustomConfirm("Удалить?", "Все видео пропадут.")) deleteDoc(doc(categoriesCollectionRef, id));
            }
            if (e.target.closest('.add-video-btn')) {
                videoForm.reset(); videoModalTitle.textContent = "Добавить"; categoryIdInput.value = e.target.closest('[data-category-id]').dataset.categoryId; videoIdInput.value = ""; videoModal.classList.remove('hidden');
            }
            if (e.target.closest('.edit-video-btn')) {
                const catId = e.target.closest('[data-category-id]').dataset.categoryId;
                const vidId = e.target.closest('.edit-video-btn').dataset.videoId;
                const cat = await getCategory(catId);
                const vid = cat.videos.find(v => v.id === vidId);
                videoModalTitle.textContent = "Редактировать"; categoryIdInput.value = catId; videoIdInput.value = vidId; videoNameInput.value=vid.name; videoUrlInput.value=vid.url; videoDescInput.value=vid.description; videoModal.classList.remove('hidden');
            }
            if (e.target.closest('.delete-video-btn')) {
                const catId = e.target.closest('[data-category-id]').dataset.categoryId;
                const vidId = e.target.closest('.delete-video-btn').dataset.videoId;
                if (await showCustomConfirm("Удалить?", "Уверены?")) {
                    const snap = await getDoc(doc(categoriesCollectionRef, catId));
                    updateDoc(doc(categoriesCollectionRef, catId), {videos: snap.data().videos.filter(v => v.id !== vidId)});
                }
            }
        });

        videoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const ref = doc(categoriesCollectionRef, categoryIdInput.value);
            const snap = await getDoc(ref);
            let vids = snap.data().videos || [];
            const newV = {id: videoIdInput.value || crypto.randomUUID(), name: videoNameInput.value, url: videoUrlInput.value, description: videoDescInput.value};
            if (videoIdInput.value) vids = vids.map(v => v.id === newV.id ? newV : v);
            else vids.push(newV);
            await updateDoc(ref, {videos: vids});
            videoModal.classList.add('hidden');
        });

        cancelVideoModal.onclick = closeVideoModal.onclick = () => videoModal.classList.add('hidden');
        
        signinButton.onclick = () => signInWithPopup(auth, new GithubAuthProvider());
        googleSigninButton.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        signoutButton.onclick = () => signOut(auth);

        importFileInput.onchange = async (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                if(await showCustomConfirm("Импорт", "Добавить данные?")) {
                    const data = JSON.parse(ev.target.result);
                    const batch = writeBatch(db);
                    data.categories.forEach(c => {
                        const ref = doc(collection(db, categoriesCollectionRef.path));
                        const v = (c.videos||[]).map(v=>({...v, id:v.id||crypto.randomUUID()}));
                        batch.set(ref, {name:c.name, videos:v});
                    });
                    await batch.commit(); alert("Готово");
                }
            }; reader.readAsText(file);
        };
        
        exportButton.onclick = async () => {
            const s = await getDocs(categoriesCollectionRef);
            const c = []; s.forEach(d=>c.push({id:d.id,...d.data()}));
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify({categories:c},null,2)],{type:'application/json'}));
            a.download = 'backup.json'; document.body.appendChild(a); a.click(); a.remove();
        };
        
        resetButton.onclick = async () => {
            if(await showCustomConfirm("СБРОС","Удалить ВСЁ?")) {
                const s = await getDocs(categoriesCollectionRef);
                const b = writeBatch(db); s.forEach(d=>b.delete(d.ref));
                await b.commit(); alert("Очищено");
            }
        };

        // Utils
        function escapeHTML(s) { return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
        async function getCategory(id) { const s = await getDoc(doc(categoriesCollectionRef, id)); return s.exists() ? {id:s.id, ...s.data()} : null; }
        function showCustomConfirm(t, m) { return new Promise(r => { confirmTitle.textContent=t; confirmText.textContent=m; confirmModal.classList.remove('hidden'); confirmResolve=r; }); }
        confirmOk.onclick = () => { confirmModal.classList.add('hidden'); if(confirmResolve)confirmResolve(true); };
        confirmCancel.onclick = () => { confirmModal.classList.add('hidden'); if(confirmResolve)confirmResolve(false); };

        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
