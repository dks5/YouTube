<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dks5: Мой Видео-Архив</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

    <style>
        /* Стиль, имитирующий свечение с вашего скриншота */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Темно-синий/фиолетовый фон */
            color: #e0e0e0; /* Светлый текст */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .neo-glow-box {
            background-color: #2a2a4e; /* Чуть светлее фон */
            border-radius: 1.5rem; /* 24px */
            border: 1px solid #4a4a8a;
            box-shadow: 0 0 25px rgba(173, 114, 239, 0.3), /* Фиолетовое свечение */
                        0 0 10px rgba(173, 114, 239, 0.2) inset; /* Внутреннее свечение */
            transition: all 0.3s ease;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        /* Кастомный стиль для кнопок "опасных" действий */
        .btn-danger {
            background-color: #991b1b; /* red-800 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* red-700 */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="text-center w-full max-w-6xl mx-auto mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-violet-300 mb-2">dks5: Мой Видео-Архив</h1>
        <p class="text-lg md:text-xl text-gray-400 mb-6">Управление категориями и ссылками на видео</p>
        
        <div class="flex justify-center space-x-4 mb-6">
            <button id="signin-button" class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-5 rounded-lg transition-all flex items-center space-x-2">
                <ion-icon name="logo-github"></ion-icon>
                <span>Войти (Админ)</span>
            </button>
            <button id="google-signin-button" class="bg-blue-700 hover:bg-blue-600 text-white py-2 px-5 rounded-lg transition-all flex items-center space-x-2">
                <ion-icon name="logo-google"></ion-icon>
                <span>Войти (Google)</span>
            </button>
            <button id="signout-button" class="hidden bg-gray-700 hover:bg-gray-600 text-white py-2 px-5 rounded-lg transition-all flex items-center space-x-2">
                <ion-icon name="log-out-outline"></ion-icon>
                <span>Выйти</span>
            </button>
        </div>
        <p id="user-display" class="hidden text-green-400 mb-6"></p>

        <div class="flex justify-center items-center space-x-2 sm:space-x-4 flex-wrap gap-2">
            <div id="import-button-wrapper" class="relative inline-block" style="display: none;">
                <button onclick="document.getElementById('import-file-input').click()" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center space-x-2">
                    <ion-icon name="cloud-upload-outline"></ion-icon>
                    <span>Импорт JSON</span>
                </button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>

            <button id="export-button" class="bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center space-x-2" style="display: none;">
                <ion-icon name="cloud-download-outline"></ion-icon>
                <span>Экспорт JSON</span>
            </button>
            
            <button id="reset-button" class="btn-danger hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center space-x-2" style="display: none;">
                <ion-icon name="trash-bin-outline"></ion-icon>
                <span>Сброс данных</span>
            </button>
        </div>
    </header>

    <main id="main-content" class="w-full max-w-6xl mx-auto" style="display: none;">
        <div id="loading-indicator" class="text-center text-lg text-gray-400 p-10">
            <p>Загрузка данных из Firebase...</p>
            <p id="error-message" class="text-red-400 font-bold mt-4"></p>
        </div>

        <div id="add-category-box" class="neo-glow-box p-6 mb-8" style="display: none;">
            <form id="add-category-form" class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="category-name-input" placeholder="Название новой категории" class="flex-grow bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet-500" required>
                <button type="submit" class="bg-violet-600 hover:bg-violet-500 text-white font-semibold py-3 px-6 rounded-lg transition-all flex justify-center items-center space-x-2">
                    <ion-icon name="add-circle-outline"></ion-icon>
                    <span>Создать категорию</span>
                </button>
            </form>
        </div>

        <div id="categories-container" class="space-y-8">
            </div>
    </main>

    <div id="video-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="neo-glow-box w-full max-w-lg p-6 relative">
            <h3 id="video-modal-title" class="text-2xl font-bold text-violet-300 mb-6">Добавить видео</h3>
            <form id="video-form">
                <input type="hidden" id="video-id-input">
                <input type="hidden" id="category-id-input">
                <div class="mb-4">
                    <label for="video-name-input" class="block text-sm font-medium text-gray-300 mb-2">Название видео</label>
                    <input type="text" id="video-name-input" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500" required>
                </div>
                <div class="mb-4">
                    <label for="video-url-input" class="block text-sm font-medium text-gray-300 mb-2">URL (ссылка)</label>
                    <input type="url" id="video-url-input" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500" required>
                </div>
                <div class="mb-6">
                    <label for="video-desc-input" class="block text-sm font-medium text-gray-300 mb-2">Описание (по желанию)</label>
                    <textarea id="video-desc-input" rows="3" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-violet-500"></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-video-modal" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg transition-all">Отмена</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-5 rounded-lg transition-all">Сохранить</button>
                </div>
            </form>
            <button id="close-video-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-all">
                <ion-icon name="close-outline" class="text-3xl"></ion-icon>
            </button>
        </div>
    </div>
    
    <div id="custom-confirm-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="neo-glow-box w-full max-w-md p-6 relative">
            <h3 id="custom-confirm-title" class="text-2xl font-bold text-yellow-300 mb-4">Требуется подтверждение</h3>
            <p id="custom-confirm-text" class="text-gray-300 mb-6">Вы уверены?</p>
            <div class="flex justify-end space-x-4">
                <button id="custom-confirm-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg transition-all">Отмена</button>
                <button id="custom-confirm-ok" class="bg-red-600 hover:bg-red-500 text-white font-semibold py-2 px-5 rounded-lg transition-all">Подтвердить</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Импорт необходимых функций Firebase
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            // signInAnonymously, // УДАЛЕНО
            GithubAuthProvider,
            GoogleAuthProvider, // ДОБАВЛЕНО
            signInWithPopup,
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Глобальные переменные ---
        
        // =======================================================================
        // 1. НАСТРОЙКА ДЛЯ GITHUB PAGES
        // =======================================================================
        const MANUAL_FIREBASE_CONFIG = {
            "apiKey": "AIzaSyAI2eGIMAHw3LWpRTATXBd2di6d2nJoj2w",
            "authDomain": "archive-89fc1.firebaseapp.com",
            "projectId": "archive-89fc1",
            "storageBucket": "archive-89fc1.firebasestorage.app",
            "messagingSenderId": "1023136270041",
            "appId": "1:1023136270041:web:02af4902a9d9f53c4920c8"
        };
        const MANUAL_APP_ID = "youtube-archive-data";
        
        // 2. ВАЖНО! Установите UIDы доступа
        const ADMIN_UID = "56vTQLliI7gcBuvOgKdFzBDl90y1"; // Ваш GitHub UID
        const VIEWER_UID = "pGNffia925Pb4lXcjTODFGtrNlL2"; // UID Google-пользователя (Аккаунт №2)
        // =======================================================================
        
        let db, auth, userId, appId;
        let categoriesCollectionRef; 
        let unsubscribeCategories = null; 

        // Элементы UI
        const mainContent = document.getElementById('main-content'); // ДОБАВЛЕНО
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const categoriesContainer = document.getElementById('categories-container');
        
        const importButtonWrapper = document.getElementById('import-button-wrapper');
        const importFileInput = document.getElementById('import-file-input');
        
        const exportButton = document.getElementById('export-button');
        const resetButton = document.getElementById('reset-button');
        
        const signinButton = document.getElementById('signin-button');
        const googleSigninButton = document.getElementById('google-signin-button'); // ДОБАВЛЕНО
        const signoutButton = document.getElementById('signout-button');
        const userDisplay = document.getElementById('user-display');
        
        const addCategoryBox = document.getElementById('add-category-box');
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryNameInput = document.getElementById('category-name-input');

        // Элементы модального окна видео
        const videoModal = document.getElementById('video-modal');
        const videoModalTitle = document.getElementById('video-modal-title');
        const videoForm = document.getElementById('video-form');
        const videoIdInput = document.getElementById('video-id-input');
        const categoryIdInput = document.getElementById('category-id-input');
        const videoNameInput = document.getElementById('video-name-input');
        const videoUrlInput = document.getElementById('video-url-input');
        const videoDescInput = document.getElementById('video-desc-input');
        const cancelVideoModal = document.getElementById('cancel-video-modal');
        const closeVideoModal = document.getElementById('close-video-modal');
        
        // Элементы модального окна подтверждения
        const confirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('custom-confirm-title');
        const confirmText = document.getElementById('custom-confirm-text');
        const confirmCancel = document.getElementById('custom-confirm-cancel');
        const confirmOk = document.getElementById('custom-confirm-ok');
        let confirmResolve = null; 

        
        // --- Инициализация Firebase ---
        
        async function initFirebase() {
            try {
                let firebaseConfig, canvasAppId;
                
                if (typeof __firebase_config !== 'undefined' && typeof __app_id !== 'undefined') {
                    console.log("Running in Canvas environment.");
                    firebaseConfig = JSON.parse(__firebase_config);
                    canvasAppId = __app_id;
                } 
                else if (MANUAL_FIREBASE_CONFIG && MANUAL_APP_ID) {
                    console.log("Running in production (GitHub) with manual config.");
                    firebaseConfig = MANUAL_FIREBASE_CONFIG;
                    canvasAppId = MANUAL_APP_ID;
                } 
                else {
                    throw new Error("Firebase config not found. Please fill in MANUAL_FIREBASE_CONFIG and MANUAL_APP_ID in the script to run on GitHub.");
                }

                appId = canvasAppId; 
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // setLogLevel('debug'); // Можно раскомментировать для отладки
                
                const collectionPath = `artifacts/${appId}/public/data/categories`;
                console.log("Using collection path:", collectionPath);
                categoriesCollectionRef = collection(db, collectionPath);

                // ==================================================
                // ИЗМЕНЕНА ЛОГИКА АУТЕНТИФИКАЦИИ
                // ==================================================
                onAuthStateChanged(auth, (user) => {
                    
                    if (user) {
                        // Пользователь вошел (GitHub ИЛИ Google)
                        console.log("User is authenticated:", user.uid);
                        userId = user.uid; 
                        
                        const isAdmin = user.uid === ADMIN_UID;
                        const isViewer = user.uid === VIEWER_UID;
                        
                        console.log(`isAdmin: ${isAdmin}, isViewer: ${isViewer}`);

                        // Настраиваем UI
                        setupInterface(user, isAdmin, isViewer);
                        
                        // Загружаем данные ТОЛЬКО если пользователь авторизован
                        if (isAdmin || isViewer) {
                            setupCategoriesListener(isAdmin); // Передаем флаг админа
                        }

                    } else {
                        // Пользователя нет (вышел или не входил)
                        console.log("User is not authenticated. Showing sign-in buttons.");
                        // НЕ входим анонимно
                        setupInterface(null, false, false);
                        loadingIndicator.classList.add('hidden');
                        categoriesContainer.innerHTML = ''; // Очищаем
                    }
                });
                // ==================================================

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingIndicator.textContent = "Ошибка инициализации Firebase.";
                errorMessage.textContent = error.message;
            }
        }
        
        // --- Настройка UI (СИЛЬНО ИЗМЕНЕНА) ---
        
        function setupInterface(user, isAdmin, isViewer) {
            
            // Скрываем/показываем элементы управления на основе статуса 'isAdmin'
            const adminDisplay = isAdmin ? 'flex' : 'none';
            const adminBlockDisplay = isAdmin ? 'block' : 'none';
            const adminInlineBlockDisplay = isAdmin ? 'inline-block' : 'none';

            // Админ-кнопки
            addCategoryBox.style.display = adminBlockDisplay;
            exportButton.style.display = adminDisplay;
            importButtonWrapper.style.display = adminInlineBlockDisplay;
            resetButton.style.display = adminDisplay;

            if (!user) {
                // --- Состояние: Пользователь не вошел ---
                mainContent.style.display = 'none'; // Скрываем весь контент
                signinButton.style.display = 'flex';
                googleSigninButton.style.display = 'flex';
                signoutButton.style.display = 'none';
                userDisplay.classList.add('hidden');
                
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.textContent = "Пожалуйста, войдите для просмотра архива.";
                errorMessage.textContent = '';
                
            } else {
                // --- Состояние: Пользователь вошел ---
                signinButton.style.display = 'none';
                googleSigninButton.style.display = 'none';
                signoutButton.style.display = 'flex';
                userDisplay.classList.remove('hidden');
                loadingIndicator.classList.add('hidden'); // Скрываем загрузчик по умолчанию

                if (isAdmin) {
                    // --- Админ ---
                    mainContent.style.display = 'block'; // Показываем контент
                    userDisplay.textContent = `Вы вошли как: ${user.displayName || 'Администратор'} (Админ)`;
                    userDisplay.classList.remove('text-red-400');
                    userDisplay.classList.add('text-green-400');
                
                } else if (isViewer) {
                    // ---
